function getRandomInt(n,t){return Math.floor(Math.random()*(t-n+1))+n}function fillLeaderBoard(n,t){var r="/api/leaderboard/top10/"+n,i=t+"-table";$.getJSON(r,function(n){$(i).find("tr:gt(0)").remove();$.each(n.items,function(n,t){$(i).append("<tr><td>"+t.nickName+"<\/td><td>"+t.movesCount+"<\/td><\/tr>")});$(t+"-name").text(n.name);$(t).removeClass("hidden")})}var startGame=function(){function i(i){function d(){var n=JSON.stringify({id:t,nickName:$("#nickname").val(),email:$("#email").val()});$.ajax({url:"/api/games/contact",type:"post",data:n,dataType:"json",accept:"application/json",contentType:"application/json"})}function rt(){var i=new Date,r=i-nt,u=JSON.stringify({id:t,duration:r,finishedTime:i,movesCount:tt,speciesId:n});$.ajax({url:"/api/games/finish",type:"post",data:u,dataType:"json",accept:"application/json",contentType:"application/json"})}function ut(){var i=JSON.stringify({duration:null,finishedTime:null,movesCount:null,speciesId:n});$.ajax({url:"/api/games/start",type:"post",data:i,dataType:"json",accept:"application/json",contentType:"application/json",success:function(n){t=n.id},error:function(n){console.log("postGameEvent error: "+n.description)}});s("started",null,null)}function s(i,r,u){var f=new Date,e,o;e=w!=null?f-w:null;o=JSON.stringify({label:i,card:r,time:f,millisecondsSinceLastEvent:e,gameId:t,speciesId:n,row:Math.floor(u/p),column:u%p});w=f;$.ajax({url:"/api/events/",type:"post",data:o,dataType:"json",accept:"application/json",contentType:"application/json",error:function(n){console.log("postGameEvent error: "+n.description)}})}function ft(){if(rt(),h>=f)for(var n=0;n<f;n++)console.log(u[n]),$(u[n].cardId).text(u[n].name);$("#next-game").removeClass("hidden").text("next game").off("click").on("click",function(){startGame("nextrandom")})}var g=i.sets,y=!1,f=i.cardCount,p=i.columnCount,et=g.length,e=null,h=0,w=null,nt=null,tt=0,c,b,u,o,l,k,a,it,r,v;$("#game-description").text(i.description);$("#nickname").off("change").on("change",function(){d()});$("#email").off("change").on("change",function(){d()});for($("#next-game").off("click").addClass("hidden"),c=0,b=0,r=0;r<f;r++)c==0&&(rowId="row"+b,$("#cards").append("<div class='row' id='"+rowId+"'><\/div>")),cardId="card"+r,$("#"+rowId).append("<div class='card cardCovered' id='"+cardId+"'><\/div>"),c++,c==p&&(b++,c=0);for(u=[],o=[],r=0;r<et;r++)o.push({index:r,weight:getRandomInt(0,1e3),species:g[r]});for(o.sort(function(n,t){return n.weight-t.weight}),speciesIndex=0,r=0;r<f;r+=2,speciesIndex++){for(l=[],k=o[speciesIndex].species.subSets,a=0;a<k.length;a++)it=getRandomInt(0,k[a].length-1),l.push({weight:getRandomInt(0,1e3),url:o[speciesIndex].species.subSets[a][it]});l.sort(function(n,t){return n.weight-t.weight});u.push({setIndex:o[speciesIndex].index,weight:getRandomInt(0,1e3),url:l[0].url,name:o[speciesIndex].species.name});u.push({setIndex:o[speciesIndex].index,weight:getRandomInt(0,1e3),url:l[1].url,name:o[speciesIndex].species.name})}for(u.sort(function(n,t){return n.weight-t.weight}),nt=new Date,ut(),r=0;r<f;r++){u[r].index=r;u[r].cardId="#card"+r;v=u[r];console.log(v);$(v.cardId).addClass("cardCovered").on("click",v,function(n){var i;if(!y){y=!0;var r=n.data.cardId,u=n.data.url,t=n.data,o=$(r).hasClass("cardUncovered");$(r).addClass("cardPlaying").removeClass("cardCovered").addClass("cardUncovered");i=new Audio(u);i.onended=function(){if($(t.cardId).removeClass("cardPlaying"),y=!1,o){console.log("Sound finished for already uncovered card: ");console.log(t);return}console.log("Sound finished for card: ");console.log(t);console.log("First selected card: "+e);console.log(e);h<f?(tt++,console.log("matchCount "+h+"; cardCount "+f),e!=null&&e.cardId!=t.cardId?(e.setIndex!=t.setIndex?($(t.cardId).removeClass("cardUncovered"),$(t.cardId).addClass("cardCovered"),$(e.cardId).removeClass("cardUncovered"),$(e.cardId).addClass("cardCovered"),s("mismatch",t.url,t.index)):(h+=2,console.log(h+", "+f),h>=f?(s("finished",t.url,t.index),ft()):s("match",t.url,t.index)),e=null):(s("first",t.url,t.index),e=t)):s("after the win",t.url,t.index)};i.play();console.log("Card selected: ");console.log(t)}})}}var t=null,n=null;return function(t){$("#cards").empty();$("#leaderboard").addClass("hidden");$("#nickname").empty();$("#email").empty();n=t;$.getJSON("/api/species/"+t,function(t){n=t.result.id;i(t.result)})}}();
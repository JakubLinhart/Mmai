function getRandomInt(n,t){return Math.floor(Math.random()*(t-n+1))+n}function fillLeaderBoard(n,t){var r="/api/statistics/top10/"+n,i=t+"-table";$.getJSON(r,function(n){$(i).find("tr:gt(0)").remove();$.each(n.items,function(n,t){$(i).append("<tr><td>"+t.nickName+"<\/td><td>"+t.movesCount+"<\/td><\/tr>")});$(t+"-name").text(n.name);$(t).removeClass("hidden")})}function fillAllGameStatistics(n,t){var i="/api/statistics/allgames/"+t;$.getJSON(i,function(t){$(n).text(t.meanTurnsCount)})}var startGame=function(){function i(i){function nt(){var n=JSON.stringify({id:t,nickName:$("#nickname").val(),email:$("#email").val()});$.ajax({url:"/api/games/contact",type:"post",data:n,dataType:"json",accept:"application/json",contentType:"application/json"})}function ft(){var i=new Date,r=i-it,u=JSON.stringify({id:t,duration:r,finishedTime:i,movesCount:rt,turnsCount:c,speciesId:n});$.ajax({url:"/api/games/finish",type:"post",data:u,dataType:"json",accept:"application/json",contentType:"application/json"})}function et(){var i=JSON.stringify({duration:null,finishedTime:null,movesCount:null,speciesId:n});$.ajax({url:"/api/games/start",type:"post",data:i,dataType:"json",accept:"application/json",contentType:"application/json",success:function(n){t=n.id},error:function(n){console.log("postGameEvent error: "+n.description)}});s("started",null,null)}function s(i,r,u){var f=new Date,e,o;e=k!=null?f-k:null;o=JSON.stringify({label:i,card:r,time:f,millisecondsSinceLastEvent:e,gameId:t,speciesId:n,row:Math.floor(u/b),column:u%b});k=f;$.ajax({url:"/api/events/",type:"post",data:o,dataType:"json",accept:"application/json",contentType:"application/json",error:function(n){console.log("postGameEvent error: "+n.description)}})}function ot(){if(ft(),h>=e)for(var n=0;n<e;n++)console.log(f[n]),$(f[n].cardId).text(f[n].name);st()}function st(){$.getJSON("/api/statistics/game/"+c+"/"+t+"/"+n,function(n){$("#stats-current-turns").text(c);$("#stats-best-turns").text(n.bestTurnsCount);$("#stats-better-than-percentage").text(n.betterThanPercentage);$("#finished-game").removeClass("hidden")})}function y(n){$(n).text("")}var tt=i.sets,w=!1,e=i.cardCount,b=i.columnCount,ht=tt.length,u=null,h=0,k=null,it=null,rt=0,c=0,l,d,f,o,a,g,v,ut,r,p;$(".species-name").text(currentSpeciesName);$("#finished-game").addClass("hidden");$("#nickname").off("change").on("change",function(){nt()});$("#email").off("change").on("change",function(){nt()});$("#next-game").off("click").on("click",function(){startGame("nextrandom")});for(l=0,d=0,r=0;r<e;r++)l==0&&(rowId="row"+d,$("#cards").append("<div class='row' id='"+rowId+"'><\/div>")),cardId="card"+r,$("#"+rowId).append("<div class='card cardCovered' id='"+cardId+"'><\/div>"),l++,l==b&&(d++,l=0);for(f=[],o=[],r=0;r<ht;r++)o.push({index:r,weight:getRandomInt(0,1e3),species:tt[r]});for(o.sort(function(n,t){return n.weight-t.weight}),speciesIndex=0,r=0;r<e;r+=2,speciesIndex++){for(a=[],g=o[speciesIndex].species.subSets,v=0;v<g.length;v++)ut=getRandomInt(0,g[v].length-1),a.push({weight:getRandomInt(0,1e3),url:o[speciesIndex].species.subSets[v][ut]});a.sort(function(n,t){return n.weight-t.weight});f.push({setIndex:o[speciesIndex].index,weight:getRandomInt(0,1e3),url:a[0].url,name:o[speciesIndex].species.name});f.push({setIndex:o[speciesIndex].index,weight:getRandomInt(0,1e3),url:a[1].url,name:o[speciesIndex].species.name})}for(f.sort(function(n,t){return n.weight-t.weight}),it=new Date,et(),r=0;r<e;r++){f[r].index=r;f[r].cardId="#card"+r;p=f[r];console.log(p);$(p.cardId).addClass("cardCovered").on("click",p,function(n){var r;if(!w){w=!0;var i=n.data.cardId,o=n.data.url,t=n.data,f=$(i).hasClass("cardUncovered")||$(i).hasClass("cardPeeking");$(i).addClass("cardPlaying").removeClass("cardCovered");f?$(i).addClass("cardUncovered"):$(i).addClass("cardPeeking");r=new Audio(o);r.onended=function(){if($(t.cardId).removeClass("cardPlaying"),w=!1,f){console.log("Sound finished for already uncovered card: ");console.log(t);return}console.log("Sound finished for card: ");console.log(t);console.log("First selected card: "+u);console.log(u);h<e?(rt++,console.log("matchCount "+h+"; cardCount "+e),u!=null&&u.cardId!=t.cardId?(u.setIndex!=t.setIndex?($(t.cardId).removeClass("cardUncovered").removeClass("cardPeeking").addClass("cardCovered").text("mismatch!"),setTimeout(y,1e3,t.cardId),$(u.cardId).removeClass("cardPeeking").addClass("cardCovered").text("mismatch!").removeClass("cardUncovered"),c++,setTimeout(y,1e3,u.cardId),s("mismatch",t.url,t.index)):($(u.cardId).removeClass("cardPeeking").text("match!").addClass("cardUncovered"),$(t.cardId).removeClass("cardPeeking").text("match!").addClass("cardUncovered"),h+=2,c++,console.log(h+", "+e),h>=e?(s("finished",t.url,t.index),ot()):(setTimeout(y,1e3,t.cardId),setTimeout(y,1e3,u.cardId),s("match",t.url,t.index))),u=null):(s("first",t.url,t.index),u=t)):s("after the win",t.url,t.index)};r.play();console.log("Card selected: ");console.log(t)}})}}var t=null,n=null;return function(t){$("#cards").empty();$("#leaderboard").addClass("hidden");$("#nickname").empty();$("#email").empty();n=t;$.getJSON("/api/species/"+t,function(t){n=t.result.id;currentSpeciesName=t.result.name;i(t.result)})}}();
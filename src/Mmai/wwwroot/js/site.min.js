function getRandomInt(n,t){return Math.floor(Math.random()*(t-n+1))+n}function fillLeaderBoard(n,t){var r="/api/statistics/top10/"+n,i=t+"-table";$.getJSON(r,function(n){$(i).find("tr:gt(0)").remove();$.each(n.items,function(n,t){$(i).append("<tr><td>"+t.nickName+"<\/td><td>"+t.movesCount+"<\/td><\/tr>")});$(t+"-name").text(n.name);$(t).removeClass("hidden")})}function fillAllGameStatistics(n,t){var i="/api/statistics/allgames/"+t;$.getJSON(i,function(t){$(n).text(t.meanTurnsCount)})}var startGame=function(){function i(i){function g(){var n=JSON.stringify({id:t,nickName:$("#nickname").val(),email:$("#email").val()});$.ajax({url:"/api/games/contact",type:"post",data:n,dataType:"json",accept:"application/json",contentType:"application/json"})}function rt(){var i=new Date,r=i-tt,u=JSON.stringify({id:t,duration:r,finishedTime:i,movesCount:v,speciesId:n});$.ajax({url:"/api/games/finish",type:"post",data:u,dataType:"json",accept:"application/json",contentType:"application/json"})}function ut(){var i=JSON.stringify({duration:null,finishedTime:null,movesCount:null,speciesId:n});$.ajax({url:"/api/games/start",type:"post",data:i,dataType:"json",accept:"application/json",contentType:"application/json",success:function(n){t=n.id},error:function(n){console.log("postGameEvent error: "+n.description)}});s("started",null,null)}function s(i,r,u){var f=new Date,e,o;e=b!=null?f-b:null;o=JSON.stringify({label:i,card:r,time:f,millisecondsSinceLastEvent:e,gameId:t,speciesId:n,row:Math.floor(u/w),column:u%w});b=f;$.ajax({url:"/api/events/",type:"post",data:o,dataType:"json",accept:"application/json",contentType:"application/json",error:function(n){console.log("postGameEvent error: "+n.description)}})}function ft(){if(rt(),h>=u)for(var n=0;n<u;n++)console.log(f[n]),$(f[n].cardId).text(f[n].name);$("#next-game").removeClass("hidden").text("next game").off("click").on("click",function(){startGame("nextrandom")});et()}function et(){$.getJSON("/api/statistics/game/"+v+"/"+t+"/"+n,function(n){$("#stats-lowest-turns").text(u);$("#stats-current-turns").text(v);$("#stats-best-turns").text(n.bestTurnsCount);$("#stats-better-than-percentage").text(n.betterThanPercentage);$("#finished-game").removeClass("hidden")})}var nt=i.sets,p=!1,u=i.cardCount,w=i.columnCount,ot=nt.length,e=null,h=0,b=null,tt=null,v=0,c,k,f,o,l,d,a,it,r,y;$("#finished-game").addClass("hidden");$("#game-description").text(i.description);$("#nickname").off("change").on("change",function(){g()});$("#email").off("change").on("change",function(){g()});for($("#next-game").off("click").addClass("hidden"),c=0,k=0,r=0;r<u;r++)c==0&&(rowId="row"+k,$("#cards").append("<div class='row' id='"+rowId+"'><\/div>")),cardId="card"+r,$("#"+rowId).append("<div class='card cardCovered' id='"+cardId+"'><\/div>"),c++,c==w&&(k++,c=0);for(f=[],o=[],r=0;r<ot;r++)o.push({index:r,weight:getRandomInt(0,1e3),species:nt[r]});for(o.sort(function(n,t){return n.weight-t.weight}),speciesIndex=0,r=0;r<u;r+=2,speciesIndex++){for(l=[],d=o[speciesIndex].species.subSets,a=0;a<d.length;a++)it=getRandomInt(0,d[a].length-1),l.push({weight:getRandomInt(0,1e3),url:o[speciesIndex].species.subSets[a][it]});l.sort(function(n,t){return n.weight-t.weight});f.push({setIndex:o[speciesIndex].index,weight:getRandomInt(0,1e3),url:l[0].url,name:o[speciesIndex].species.name});f.push({setIndex:o[speciesIndex].index,weight:getRandomInt(0,1e3),url:l[1].url,name:o[speciesIndex].species.name})}for(f.sort(function(n,t){return n.weight-t.weight}),tt=new Date,ut(),r=0;r<u;r++){f[r].index=r;f[r].cardId="#card"+r;y=f[r];console.log(y);$(y.cardId).addClass("cardCovered").on("click",y,function(n){var r;if(!p){p=!0;var i=n.data.cardId,o=n.data.url,t=n.data,f=$(i).hasClass("cardUncovered")||$(i).hasClass("cardPeeking");$(i).addClass("cardPlaying").removeClass("cardCovered");f?$(i).addClass("cardUncovered"):$(i).addClass("cardPeeking");r=new Audio(o);r.onended=function(){if($(t.cardId).removeClass("cardPlaying"),p=!1,f){console.log("Sound finished for already uncovered card: ");console.log(t);return}console.log("Sound finished for card: ");console.log(t);console.log("First selected card: "+e);console.log(e);h<u?(v++,console.log("matchCount "+h+"; cardCount "+u),e!=null&&e.cardId!=t.cardId?(e.setIndex!=t.setIndex?($(t.cardId).removeClass("cardUncovered").removeClass("cardPeeking").addClass("cardCovered"),$(e.cardId).removeClass("cardPeeking").addClass("cardCovered").removeClass("cardUncovered"),s("mismatch",t.url,t.index)):($(e).removeClass("cardPeeking").addClass("cardUncovered"),$(t.cardId).removeClass("cardPeeking").addClass("cardUncovered"),h+=2,console.log(h+", "+u),h>=u?(s("finished",t.url,t.index),ft()):s("match",t.url,t.index)),e=null):(s("first",t.url,t.index),e=t)):s("after the win",t.url,t.index)};r.play();console.log("Card selected: ");console.log(t)}})}}var t=null,n=null;return function(t){$("#cards").empty();$("#leaderboard").addClass("hidden");$("#nickname").empty();$("#email").empty();n=t;$.getJSON("/api/species/"+t,function(t){n=t.result.id;i(t.result)})}}();
var species = [
    {
        name: "Jiřička Hrůzostrašná",
        subSets: [
            [
                "sounds/001/108_ci_109_2013/108_ci_109_2013_10.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_11.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_12.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_14.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_15.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_16.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_20.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_22.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_25.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_27.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_31.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_33.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_38.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_40.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_42.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_44.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_47.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_49.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_51.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_52.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_53.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_54.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_58.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_6.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_64.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_66.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_68.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_69.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_70.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_72.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_73.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_74.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_8.wav",
                "sounds/001/108_ci_109_2013/108_ci_109_2013_9.wav"
            ],
            [
                "sounds/001/108-109b_2014/108-109b_2014_10.wav",
                "sounds/001/108-109b_2014/108-109b_2014_11.wav",
                "sounds/001/108-109b_2014/108-109b_2014_12.wav",
                "sounds/001/108-109b_2014/108-109b_2014_13.wav",
                "sounds/001/108-109b_2014/108-109b_2014_14.wav",
                "sounds/001/108-109b_2014/108-109b_2014_15.wav",
                "sounds/001/108-109b_2014/108-109b_2014_16.wav",
                "sounds/001/108-109b_2014/108-109b_2014_17.wav",
                "sounds/001/108-109b_2014/108-109b_2014_18.wav",
                "sounds/001/108-109b_2014/108-109b_2014_19.wav",
                "sounds/001/108-109b_2014/108-109b_2014_2.wav",
                "sounds/001/108-109b_2014/108-109b_2014_20.wav",
                "sounds/001/108-109b_2014/108-109b_2014_21.wav",
                "sounds/001/108-109b_2014/108-109b_2014_3.wav",
                "sounds/001/108-109b_2014/108-109b_2014_4.wav",
                "sounds/001/108-109b_2014/108-109b_2014_5.wav",
                "sounds/001/108-109b_2014/108-109b_2014_6.wav",
                "sounds/001/108-109b_2014/108-109b_2014_7.wav",
                "sounds/001/108-109b_2014/108-109b_2014_8.wav",
                "sounds/001/108-109b_2014/108-109b_2014_9.wav",
            ]
        ]
    },
    {
        name: "Satan Klausův",
        subSets: [
            [
                "sounds/002/193_2013/193_2013_10.wav",
                "sounds/002/193_2013/193_2013_11.wav",
                "sounds/002/193_2013/193_2013_12.wav",
                "sounds/002/193_2013/193_2013_13.wav",
                "sounds/002/193_2013/193_2013_14.wav",
                "sounds/002/193_2013/193_2013_15.wav",
                "sounds/002/193_2013/193_2013_16.wav",
                "sounds/002/193_2013/193_2013_17.wav",
                "sounds/002/193_2013/193_2013_18.wav",
                "sounds/002/193_2013/193_2013_19.wav",
                "sounds/002/193_2013/193_2013_2.wav",
                "sounds/002/193_2013/193_2013_20.wav",
                "sounds/002/193_2013/193_2013_21.wav",
                "sounds/002/193_2013/193_2013_22.wav",
                "sounds/002/193_2013/193_2013_23.wav",
                "sounds/002/193_2013/193_2013_24.wav",
                "sounds/002/193_2013/193_2013_25.wav",
                "sounds/002/193_2013/193_2013_3.wav",
                "sounds/002/193_2013/193_2013_5.wav",
                "sounds/002/193_2013/193_2013_6.wav",
                "sounds/002/193_2013/193_2013_7.wav",
                "sounds/002/193_2013/193_2013_8.wav",
                "sounds/002/193_2013/193_2013_9.wav",
            ],
            [
                "sounds/002/193b_2014/193b_2014_1.wav",
                "sounds/002/193b_2014/193b_2014_10.wav",
                "sounds/002/193b_2014/193b_2014_11.wav",
                "sounds/002/193b_2014/193b_2014_12.wav",
                "sounds/002/193b_2014/193b_2014_13.wav",
                "sounds/002/193b_2014/193b_2014_14.wav",
                "sounds/002/193b_2014/193b_2014_15.wav",
                "sounds/002/193b_2014/193b_2014_16.wav",
                "sounds/002/193b_2014/193b_2014_17.wav",
                "sounds/002/193b_2014/193b_2014_18.wav",
                "sounds/002/193b_2014/193b_2014_19.wav",
                "sounds/002/193b_2014/193b_2014_2.wav",
                "sounds/002/193b_2014/193b_2014_20.wav",
                "sounds/002/193b_2014/193b_2014_21.wav",
                "sounds/002/193b_2014/193b_2014_22.wav",
                "sounds/002/193b_2014/193b_2014_23.wav",
                "sounds/002/193b_2014/193b_2014_24.wav",
                "sounds/002/193b_2014/193b_2014_25.wav",
                "sounds/002/193b_2014/193b_2014_26.wav",
                "sounds/002/193b_2014/193b_2014_27.wav",
                "sounds/002/193b_2014/193b_2014_3.wav",
                "sounds/002/193b_2014/193b_2014_4.wav",
                "sounds/002/193b_2014/193b_2014_5.wav",
                "sounds/002/193b_2014/193b_2014_6.wav",
                "sounds/002/193b_2014/193b_2014_7.wav",
                "sounds/002/193b_2014/193b_2014_8.wav",
                "sounds/002/193b_2014/193b_2014_9.wav",
            ]
        ]
    },
    {
        name: "Krůta Ukrutná",
        subSets: [
            [
                "sounds/003/229_spont_2013/229_spont_2013_10.wav",
                "sounds/003/229_spont_2013/229_spont_2013_11.wav",
                "sounds/003/229_spont_2013/229_spont_2013_12.wav",
                "sounds/003/229_spont_2013/229_spont_2013_13.wav",
                "sounds/003/229_spont_2013/229_spont_2013_14.wav",
                "sounds/003/229_spont_2013/229_spont_2013_15.wav",
                "sounds/003/229_spont_2013/229_spont_2013_16.wav",
                "sounds/003/229_spont_2013/229_spont_2013_17.wav",
                "sounds/003/229_spont_2013/229_spont_2013_18.wav",
                "sounds/003/229_spont_2013/229_spont_2013_19.wav",
                "sounds/003/229_spont_2013/229_spont_2013_2.wav",
                "sounds/003/229_spont_2013/229_spont_2013_3.wav",
                "sounds/003/229_spont_2013/229_spont_2013_4.wav",
                "sounds/003/229_spont_2013/229_spont_2013_5.wav",
                "sounds/003/229_spont_2013/229_spont_2013_6.wav",
                "sounds/003/229_spont_2013/229_spont_2013_7.wav",
                "sounds/003/229_spont_2013/229_spont_2013_8.wav",
                "sounds/003/229_spont_2013/229_spont_2013_9.wav"
            ],
            [
                "sounds/003/229b_2014/229b_2014_10.wav",
                "sounds/003/229b_2014/229b_2014_11.wav",
                "sounds/003/229b_2014/229b_2014_12.wav",
                "sounds/003/229b_2014/229b_2014_13.wav",
                "sounds/003/229b_2014/229b_2014_14.wav",
                "sounds/003/229b_2014/229b_2014_15.wav",
                "sounds/003/229b_2014/229b_2014_16.wav",
                "sounds/003/229b_2014/229b_2014_17.wav",
                "sounds/003/229b_2014/229b_2014_18.wav",
                "sounds/003/229b_2014/229b_2014_19.wav",
                "sounds/003/229b_2014/229b_2014_2.wav",
                "sounds/003/229b_2014/229b_2014_20.wav",
                "sounds/003/229b_2014/229b_2014_21.wav",
                "sounds/003/229b_2014/229b_2014_22.wav",
                "sounds/003/229b_2014/229b_2014_23.wav",
                "sounds/003/229b_2014/229b_2014_24.wav",
                "sounds/003/229b_2014/229b_2014_25.wav",
                "sounds/003/229b_2014/229b_2014_3.wav",
                "sounds/003/229b_2014/229b_2014_4.wav",
                "sounds/003/229b_2014/229b_2014_5.wav",
                "sounds/003/229b_2014/229b_2014_6.wav",
                "sounds/003/229b_2014/229b_2014_7.wav",
                "sounds/003/229b_2014/229b_2014_8.wav",
                "sounds/003/229b_2014/229b_2014_9.wav",
            ]
        ]
    },
    {
        name: "Pěnkava Umrlá",
        subSets: [
            [
                "sounds/004/7_2013/7_2013_1.wav",
                "sounds/004/7_2013/7_2013_12.wav",
                "sounds/004/7_2013/7_2013_13.wav",
                "sounds/004/7_2013/7_2013_14.wav",
                "sounds/004/7_2013/7_2013_15.wav",
                "sounds/004/7_2013/7_2013_16.wav",
                "sounds/004/7_2013/7_2013_17.wav",
                "sounds/004/7_2013/7_2013_2.wav",
                "sounds/004/7_2013/7_2013_4.wav",
                "sounds/004/7_2013/7_2013_8.wav",
            ],
            [
                "sounds/004/7_2014/7_2014_10.wav",
                "sounds/004/7_2014/7_2014_11.wav",
                "sounds/004/7_2014/7_2014_12.wav",
                "sounds/004/7_2014/7_2014_13.wav",
                "sounds/004/7_2014/7_2014_14.wav",
                "sounds/004/7_2014/7_2014_15.wav",
                "sounds/004/7_2014/7_2014_16.wav",
                "sounds/004/7_2014/7_2014_17.wav",
                "sounds/004/7_2014/7_2014_2.wav",
                "sounds/004/7_2014/7_2014_3.wav",
                "sounds/004/7_2014/7_2014_4.wav",
                "sounds/004/7_2014/7_2014_5.wav",
                "sounds/004/7_2014/7_2014_6.wav",
                "sounds/004/7_2014/7_2014_7.wav",
                "sounds/004/7_2014/7_2014_8.wav",
                "sounds/004/7_2014/7_2014_9.wav"
            ]
        ]
    },
    {
        name: "Ostuda Obecná",
        subSets: [
            [
                "sounds/005/94_2013/94_2013_10.wav",
                "sounds/005/94_2013/94_2013_2.wav",
                "sounds/005/94_2013/94_2013_3.wav",
                "sounds/005/94_2013/94_2013_4.wav",
                "sounds/005/94_2013/94_2013_5.wav",
            ],
            [
                "sounds/005/94_2014/94_2014_10.wav",
                "sounds/005/94_2014/94_2014_11.wav",
                "sounds/005/94_2014/94_2014_12.wav",
                "sounds/005/94_2014/94_2014_13.wav",
                "sounds/005/94_2014/94_2014_14.wav",
                "sounds/005/94_2014/94_2014_15.wav",
                "sounds/005/94_2014/94_2014_16.wav",
                "sounds/005/94_2014/94_2014_17.wav",
                "sounds/005/94_2014/94_2014_2.wav",
                "sounds/005/94_2014/94_2014_3.wav",
                "sounds/005/94_2014/94_2014_4.wav",
                "sounds/005/94_2014/94_2014_5.wav",
                "sounds/005/94_2014/94_2014_6.wav",
                "sounds/005/94_2014/94_2014_7.wav",
                "sounds/005/94_2014/94_2014_8.wav",
                "sounds/005/94_2014/94_2014_9.wav"
            ]
        ]
    }
]

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

(function () {
    var soundPlaying = false;
    var cardCount = 10;
    var setsCount = species.length;
    var firstSelectedCard = null;
    var matchCount = 0;
    var lastEventTime = null;
    var gameStartedTime = null;
    var gameId = null;
    var movesCount = 0;

    function postGameFinished() {
        var now = new Date();
        var gameDuration = now - gameStartedTime;

        var data = JSON.stringify({
            id: gameId,
            duration: gameDuration,
            finishedTime: now,
            movesCount: movesCount
        });

        $.ajax({
            url: "/api/games/finish/",
            type: "post",
            data: data,
            dataType: "json",
            accept: 'application/json',
            contentType: "application/json"
        });
    }

    function postGameEvent(label, card) {
        var now = new Date();
        var sinceLastEvent;

        if (lastEventTime != null) {
            sinceLastEvent = now - lastEventTime;
        }
        else
            sinceLastEvent = null;

        var data = JSON.stringify({
            label: label,
            card: card,
            time: now,
            millisecondsSinceLastEvent: sinceLastEvent,
            gameId: gameId
        });
        lastEventTime = now;
        $.ajax({
            url: "/api/events/",
            type: "post",
            data: data,
            dataType: "json",
            accept: 'application/json',
            contentType: "application/json",

            success: function (data) {
                gameId = data;
            },
            error: function (result) {
                alert(result);
            }
        });
    }

    if (cardCount > setsCount * 2) {
        // TODO:
        alert('More cards than sets.')
    }

    var cards = [];
    var randomizedSpecies = [];
    for (var i = 0; i < setsCount; i++) {
        randomizedSpecies.push({ index: i, weight: getRandomInt(0, 1000), species: species[i] });
    }
    randomizedSpecies.sort(function (x, y) {
        return x.weight - y.weight;
    });

    speciesIndex = 0;
    for (var i = 0; i < cardCount; i += 2, speciesIndex++) {
        var randomizedSubSets = [];
        var subSets = randomizedSpecies[speciesIndex].species.subSets;

        for (var j = 0; j < subSets.length; j++) {
            var subSetUrlIndex = getRandomInt(0, subSets[j].length - 1);
            randomizedSubSets.push({ weight: getRandomInt(0, 1000), url: randomizedSpecies[speciesIndex].species.subSets[j][subSetUrlIndex] });
        }

        randomizedSubSets.sort(function (x, y) {
            return x.weight - y.weight;
        });

        cards.push({
            setIndex: randomizedSpecies[speciesIndex].index,
            weight: getRandomInt(0, 1000),
            url: randomizedSubSets[0].url,
            name: randomizedSpecies[speciesIndex].species.name
        });
        cards.push({
            setIndex: randomizedSpecies[speciesIndex].index,
            weight: getRandomInt(0, 1000),
            url: randomizedSubSets[1].url,
            name: randomizedSpecies[speciesIndex].species.name
        });
    }

    cards.sort(function (x, y) {
        return x.weight - y.weight;
    });

    gameStartedTime = new Date();
    postGameEvent("started", null);
    for (var i = 0; i < cardCount; i++) {
        cards[i].cardId = "#card" + i;
        var card = cards[i];
        $(card.cardId).addClass("cardCovered");
        $(card.cardId).empty();
        console.log(card);

        $(document).on("click", card.cardId, card, function (e) {
            if (soundPlaying)
                return;

            soundPlaying = true;
            var cardId = e.data.cardId;
            var url = e.data.url;
            var card = e.data;

            $(cardId).addClass("cardPlaying");
            $(cardId).removeClass("cardCovered");
            $(cardId).addClass("cardUncovered");
            var audio = new Audio(url);
            audio.onended = function () {
                $(card.cardId).removeClass("cardPlaying");
                soundPlaying = false;

                console.log("Sound finished for card: ");
                console.log(card);
                console.log("First selected card: " + firstSelectedCard);
                console.log(firstSelectedCard);

                if (matchCount < cardCount) {
                    movesCount++;
                    console.log("matchCount " + matchCount + "; cardCount " + cardCount);
                    if (firstSelectedCard != null && firstSelectedCard.cardId != card.cardId) {
                        if (firstSelectedCard.setIndex != card.setIndex) {
                            $(card.cardId).removeClass("cardUncovered");
                            $(card.cardId).addClass("cardCovered");
                            $(firstSelectedCard.cardId).removeClass("cardUncovered");
                            $(firstSelectedCard.cardId).addClass("cardCovered");
                            postGameEvent("mismatch", card.url);
                        }
                        else {
                            matchCount += 2;
                            console.log(matchCount + ", " + cardCount)
                            if (matchCount >= cardCount) {
                                for (var i = 0; i < cardCount; i++) {
                                    console.log(cards[i]);
                                    $(cards[i].cardId).text(cards[i].name);
                                }
                                won = true;
                            }
                            postGameEvent("match", card.url);
                            postGameFinished();
                        }
                        firstSelectedCard = null;
                    }
                    else {
                        postGameEvent("first", card.url);
                        firstSelectedCard = card;
                    }
                }
                else {
                    postGameEvent("after the win", card.url);
                }
            }
            audio.play();
            console.log("Card selected: ");
            console.log(card)
        });
    }
})();